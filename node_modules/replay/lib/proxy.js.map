{"version":3,"sources":["proxy.js"],"names":["assert","require","EventEmitter","HTTP","HTTPS","Stream","URL","module","exports","ProxyRequest","IncomingMessage","constructor","options","proxy","method","toUpperCase","protocol","_defaultAgent","host","hostname","split","port","realPort","url","parse","path","auth","agent","globalAgent","headers","name","value","toLowerCase","toString","flushHeaders","setHeader","ended","body","getHeader","removeHeader","addTrailers","trailers","setTimeout","timeout","callback","setImmediate","setNoDelay","setSocketKeepAlive","write","chunk","encoding","push","end","data","error","captured","emit","response","ProxyResponse","resume","Error","format","code","errno","flush","abort","Readable","once","httpVersion","version","httpVersionMajor","httpVersionMinor","statusCode","parseInt","statusMessage","STATUS_CODES","Object","assign","rawHeaders","slice","rawTrailers","connection","_body","_read","part","shift","msec","notFound","status"],"mappings":"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","file":"proxy.js","sourcesContent":["// A proxy is a function that receives two arguments, a request object and a callback.\n//\n// If it can generate a respone, it calls callback with null and the response object.  Otherwise, either calls callback\n// with no arguments, or with an error to stop the processing chain.\n//\n// The request consists of:\n// url     - URL object\n// method  - Request method (lower case)\n// headers - Headers object (names are lower case)\n// body    - Request body, an array of body part/encoding pairs\n//\n// The response consists of:\n// version   - HTTP version\n// status    - Status code\n// headers   - Headers object (names are lower case)\n// body      - Array of body parts\n// trailers  - Trailers object (names are lower case)\n//\n// This file defines ProxyRequest, which acts as an HTTP ClientRequest that captures the request and passes it to the\n// proxy chain, and ProxyResponse, which acts as an HTTP ClientResponse, playing back a response it received from the\n// proxy.\n//\n// No actual proxies defined here.\n\n\nconst assert            = require('assert');\nconst { EventEmitter }  = require('events');\nconst HTTP              = require('http');\nconst HTTPS             = require('https');\nconst Stream            = require('stream');\nconst URL               = require('url');\n\n\n// HTTP client request that captures the request and sends it down the processing chain.\nmodule.exports = class ProxyRequest extends HTTP.IncomingMessage {\n\n  constructor(options = {}, proxy) {\n    super();\n    this.proxy          = proxy;\n    this.method         = (options.method || 'GET').toUpperCase();\n    const protocol      = options.protocol || (options._defaultAgent && options._defaultAgent.protocol) || 'http:';\n    const [host, port]  = (options.host || options.hostname).split(':');\n    const realPort      = options.port || port || (protocol === 'https:' ? 443 : 80);\n    this.url            = URL.parse(`${protocol}//${host || 'localhost'}:${realPort}${options.path || '/'}`, true);\n    this.auth           = options.auth;\n    this.agent          = options.agent || (protocol === 'https:' ? HTTPS.globalAgent : HTTP.globalAgent);\n    this.headers        = {};\n    if (options.headers)\n      for (let name in options.headers) {\n        let value = options.headers[name];\n        if (value != null)\n          this.headers[name.toLowerCase()] = value.toString();\n      }\n  }\n\n  flushHeaders() {\n  }\n\n  setHeader(name, value) {\n    assert(!this.ended, 'Already called end');\n    assert(!this.body, 'Already wrote body parts');\n    this.headers[name.toLowerCase()] = value;\n  }\n\n  getHeader(name) {\n    return this.headers[name.toLowerCase()];\n  }\n\n  removeHeader(name) {\n    assert(!this.ended, 'Already called end');\n    assert(!this.body, 'Already wrote body parts');\n    delete this.headers[name.toLowerCase()];\n  }\n\n  addTrailers(trailers) {\n    this.trailers = trailers;\n  }\n\n  setTimeout(timeout, callback) {\n    if (callback)\n      setImmediate(callback);\n  }\n\n  setNoDelay(/*nodelay = true*/) {\n  }\n\n  setSocketKeepAlive(/*enable = false, initial*/) {\n  }\n\n  write(chunk, encoding, callback) {\n    assert(!this.ended, 'Already called end');\n    this.body = this.body || [];\n    this.body.push([chunk, encoding]);\n    if (callback)\n      setImmediate(callback);\n  }\n\n  end(data, encoding, callback) {\n    assert(!this.ended, 'Already called end');\n\n    if (typeof data === 'function')\n      [ callback, data ] = [ data, null ];\n    else if (typeof encoding === 'function')\n      [ callback, encoding ] = [ encoding, null ];\n\n    if (data) {\n      this.body = this.body || [];\n      this.body.push([ data, encoding ]);\n    }\n    this.ended = true;\n\n    if (callback)\n      setImmediate(callback);\n\n    this.proxy(this, (error, captured)=> {\n      // We're not asynchronous, but clients expect us to callback later on\n      setImmediate(()=> {\n        if (error)\n          this.emit('error', error);\n        else if (captured) {\n          const response = new ProxyResponse(captured);\n          this.emit('response', response);\n          response.resume();\n        } else {\n          const error = new Error(`${this.method} ${URL.format(this.url)} refused: not recording and no network access`);\n          error.code  = 'ECONNREFUSED';\n          error.errno = 'ECONNREFUSED';\n          this.emit('error', error);\n        }\n      });\n    });\n  }\n\n  flush() {\n  }\n\n  abort() {\n  }\n\n};\n\n\n// HTTP client response that plays back a captured response.\nclass ProxyResponse extends Stream.Readable {\n\n  constructor(captured) {\n    super();\n    this.once('end', ()=> {\n      this.emit('close');\n    });\n\n    this.httpVersion      = captured.version || '1.1';\n    this.httpVersionMajor = this.httpVersion.split('.')[0];\n    this.httpVersionMinor = this.httpVersion.split('.')[1];\n    this.statusCode       = parseInt(captured.statusCode || 200, 10);\n    this.statusMessage    = captured.statusMessage || HTTP.STATUS_CODES[this.statusCode] || '';\n    this.headers          = Object.assign({ }, captured.headers);\n    this.rawHeaders       = (captured.rawHeaders || [].slice(0));\n    this.trailers         = Object.assign({ }, captured.trailers);\n    this.rawTrailers      = (captured.rawTrailers || []).slice(0);\n    // Not a documented property, but request seems to use this to look for HTTP parsing errors\n    this.connection       = new EventEmitter();\n    this._body            = captured.body.slice(0);\n  }\n\n  _read() {\n    const part = this._body.shift();\n    if (part)\n      this.push(part[0], part[1]);\n    else\n      this.push(null);\n  }\n\n  setTimeout(msec, callback) {\n    if (callback)\n      setImmediate(callback);\n  }\n\n  static notFound(url) {\n    return new ProxyResponse({\n      status: 404,\n      body:   [ `No recorded request/response that matches ${URL.format(url)}` ]\n    });\n  }\n\n}\n\n"],"sourceRoot":"/source/"}