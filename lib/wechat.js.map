{"version":3,"sources":["../src/wechat.js"],"names":["WechatCore","EventEmitter","_","getCONF","isStandardBrowserEnv","ContactFactory","MessageFactory","_debug","debug","process","on","err","console","log","Wechat","constructor","data","extend","state","CONF","STATE","init","contacts","Contact","Message","lastSyncTime","syncPollingId","syncErrorCount","checkPollingId","retryPollingId","friendList","members","key","member","push","username","nickname","getDisplayName","py","avatar","AvatarUrl","sendMsg","msg","toUserName","sendText","emoticonMd5","sendEmoticon","uploadMedia","file","filename","then","res","ext","sendPic","mediaId","sendVideo","sendDoc","name","size","syncPolling","id","login","syncCheck","selector","SYNCCHECK_SELECTOR_NORMAL","sync","handleSync","Date","now","catch","emit","Error","clearTimeout","setTimeout","restart","_getContact","Seq","getContact","MemberList","_contacts","concat","emptyGroup","filter","contact","UserName","startsWith","MemberCount","length","batchGetContact","_init","updateContacts","ContactList","notifyMobile","checkPolling","_login","checkLogin","code","userAvatar","getUUID","uuid","redirect_uri","start","stop","response","Promise","resolve","logout","interval","_getPollingMessage","_getPollingTarget","_getPollingInterval","AddMsgCount","handleMsg","AddMsgList","ModContactCount","ModContactList","forEach","FromUserName","MsgType","MSGTYPE_STATUSNOTIFY","userList","StatusNotifyUserName","split","map","all","chunk","list","ToUserName","Content","test","oldContact","i","Object","assign","toLocaleString","setPollingMessageGetter","func","setPollingIntervalGetter","setPollingTargetGetter","exports","module"],"mappings":"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","file":"wechat.js","sourcesContent":["import WechatCore from './core'\r\nimport EventEmitter from 'events'\r\n\r\nimport _ from 'lodash'\r\nimport {\r\n  getCONF,\r\n  isStandardBrowserEnv\r\n} from './util'\r\n\r\nimport ContactFactory from './interface/contact'\r\nimport MessageFactory from './interface/message'\r\n\r\nimport _debug from 'debug'\r\nconst debug = _debug('wechat')\r\n\r\nif (!isStandardBrowserEnv) {\r\n  process.on('uncaughtException', err => {\r\n    console.log('uncaughtException', err)\r\n  })\r\n}\r\n\r\nclass Wechat extends WechatCore {\r\n\r\n  constructor (data) {\r\n    super(data)\r\n    _.extend(this, new EventEmitter())\r\n    this.state = this.CONF.STATE.init\r\n    this.contacts = {} // 所有联系人\r\n    this.Contact = ContactFactory(this)\r\n    this.Message = MessageFactory(this)\r\n    this.lastSyncTime = 0\r\n    this.syncPollingId = 0\r\n    this.syncErrorCount = 0\r\n    this.checkPollingId = 0\r\n    this.retryPollingId = 0\r\n  }\r\n\r\n  get friendList () {\r\n    let members = []\r\n\r\n    for (let key in this.contacts) {\r\n      let member = this.contacts[key]\r\n      members.push({\r\n        username: member['UserName'],\r\n        nickname: this.Contact.getDisplayName(member),\r\n        py: member['RemarkPYQuanPin'] ? member['RemarkPYQuanPin'] : member['PYQuanPin'],\r\n        avatar: member.AvatarUrl\r\n      })\r\n    }\r\n\r\n    return members\r\n  }\r\n\r\n  sendMsg (msg, toUserName) {\r\n    if (typeof msg !== 'object') {\r\n      return this.sendText(msg, toUserName)\r\n    } else if (msg.emoticonMd5) {\r\n      return this.sendEmoticon(msg.emoticonMd5, toUserName)\r\n    } else {\r\n      return this.uploadMedia(msg.file, msg.filename, toUserName)\r\n        .then(res => {\r\n          switch (res.ext) {\r\n            case 'bmp':\r\n            case 'jpeg':\r\n            case 'jpg':\r\n            case 'png':\r\n              return this.sendPic(res.mediaId, toUserName)\r\n            case 'gif':\r\n              return this.sendEmoticon(res.mediaId, toUserName)\r\n            case 'mp4':\r\n              return this.sendVideo(res.mediaId, toUserName)\r\n            default:\r\n              return this.sendDoc(res.mediaId, res.name, res.size, res.ext, toUserName)\r\n          }\r\n        })\r\n    }\r\n  }\r\n\r\n  syncPolling (id = ++this.syncPollingId) {\r\n    if (this.state !== this.CONF.STATE.login || this.syncPollingId !== id) {\r\n      return\r\n    }\r\n    this.syncCheck().then(selector => {\r\n      debug('Sync Check Selector: ', selector)\r\n      if (+selector !== this.CONF.SYNCCHECK_SELECTOR_NORMAL) {\r\n        return this.sync().then(data => {\r\n          this.syncErrorCount = 0\r\n          this.handleSync(data)\r\n        })\r\n      }\r\n    }).then(() => {\r\n      this.lastSyncTime = Date.now()\r\n      this.syncPolling(id)\r\n    }).catch(err => {\r\n      if (this.state !== this.CONF.STATE.login) {\r\n        return\r\n      }\r\n      debug(err)\r\n      this.emit('error', err)\r\n      if (++this.syncErrorCount > 2) {\r\n        let err = new Error(`连续${this.syncErrorCount}次同步失败，5s后尝试重启`)\r\n        debug(err)\r\n        this.emit('error', err)\r\n        clearTimeout(this.retryPollingId)\r\n        setTimeout(() => this.restart(), 5 * 1000)\r\n      } else {\r\n        clearTimeout(this.retryPollingId)\r\n        this.retryPollingId = setTimeout(() => this.syncPolling(id), 2000 * this.syncErrorCount)\r\n      }\r\n    })\r\n  }\r\n\r\n  _getContact (Seq = 0) {\r\n    let contacts = []\r\n    return this.getContact(Seq)\r\n    .then(res => {\r\n      contacts = res.MemberList || []\r\n      if (res.Seq) {\r\n        return this._getContact(res.Seq)\r\n        .then(_contacts => contacts = contacts.concat(_contacts || []))\r\n      }\r\n    })\r\n    .then(() => {\r\n      if (Seq == 0) {\r\n        let emptyGroup =\r\n          contacts.filter(contact => contact.UserName.startsWith('@@') && contact.MemberCount == 0)\r\n        if (emptyGroup.length != 0) {\r\n          return this.batchGetContact(emptyGroup)\r\n          .then(_contacts => contacts = contacts.concat(_contacts || []))\r\n        } else {\r\n          return contacts\r\n        }\r\n      } else {\r\n        return contacts\r\n      }\r\n    })\r\n    .catch(err => {\r\n      this.emit('error', err)\r\n      return contacts\r\n    })\r\n  }\r\n\r\n  _init () {\r\n    return this.init()\r\n    .then(data => {\r\n      // this.getContact() 这个接口返回通讯录中的联系人（包括已保存的群聊）\r\n      // 临时的群聊会话在初始化的接口中可以获取，因此这里也需要更新一遍 contacts\r\n      // 否则后面可能会拿不到某个临时群聊的信息\r\n      this.updateContacts(data.ContactList)\r\n\r\n      this.notifyMobile()\r\n      .catch(err => this.emit('error', err))\r\n      this._getContact()\r\n      .then(contacts => {\r\n        debug('getContact count: ', contacts.length)\r\n        this.updateContacts(contacts)\r\n      })\r\n      this.state = this.CONF.STATE.login\r\n      this.lastSyncTime = Date.now()\r\n      this.syncPolling()\r\n      this.checkPolling()\r\n      this.emit('login')\r\n    })\r\n  }\r\n\r\n  _login () {\r\n    const checkLogin = () => {\r\n      return this.checkLogin()\r\n        .then(res => {\r\n          if (res.code === 201 && res.userAvatar) {\r\n            this.emit('user-avatar', res.userAvatar)\r\n          }\r\n          if (res.code !== 200) {\r\n            debug('checkLogin: ', res.code)\r\n            return checkLogin()\r\n          } else {\r\n            return res\r\n          }\r\n        })\r\n    }\r\n    return this.getUUID()\r\n      .then(uuid => {\r\n        debug('getUUID: ', uuid)\r\n        this.emit('uuid', uuid)\r\n        this.state = this.CONF.STATE.uuid\r\n        return checkLogin()\r\n      })\r\n      .then(res => {\r\n        debug('checkLogin: ', res.redirect_uri)\r\n        return this.login()\r\n      })\r\n  }\r\n\r\n  start () {\r\n    debug('启动中...')\r\n    return this._login()\r\n      .then(() => this._init())\r\n      .catch(err => {\r\n        debug(err)\r\n        this.emit('error', err)\r\n        this.stop()\r\n      })\r\n  }\r\n\r\n  restart () {\r\n    debug('重启中...')\r\n    return this._init()\r\n      .catch(err => {\r\n        if (err.response) {\r\n          throw err\r\n        } else {\r\n          let err = new Error('重启时网络错误，60s后进行最后一次重启')\r\n          debug(err)\r\n          this.emit('error', err)\r\n          return new Promise(resolve => {\r\n            setTimeout(resolve, 60 * 1000)\r\n          }).then(() => this.init())\r\n            .then(data => {\r\n              this.updateContacts(data.ContactList)\r\n            })\r\n        }\r\n      }).catch(err => {\r\n        debug(err)\r\n        this.emit('error', err)\r\n        this.stop()\r\n      })\r\n  }\r\n\r\n  stop () {\r\n    debug('登出中...')\r\n    clearTimeout(this.retryPollingId)\r\n    clearTimeout(this.checkPollingId)\r\n    this.logout()\r\n    this.state = this.CONF.STATE.logout\r\n    this.emit('logout')\r\n  }\r\n\r\n  checkPolling () {\r\n    if (this.state !== this.CONF.STATE.login) {\r\n      return\r\n    }\r\n    let interval = Date.now() - this.lastSyncTime\r\n    if (interval > 1 * 60 * 1000) {\r\n      let err = new Error(`状态同步超过${interval / 1000}s未响应，5s后尝试重启`)\r\n      debug(err)\r\n      this.emit('error', err)\r\n      clearTimeout(this.checkPollingId)\r\n      setTimeout(() => this.restart(), 5 * 1000)\r\n    } else {\r\n      debug('心跳')\r\n      this.notifyMobile()\r\n      .catch(err => {\r\n        debug(err)\r\n        this.emit('error', err)\r\n      })\r\n      this.sendMsg(this._getPollingMessage(), this._getPollingTarget())\r\n      .catch(err => {\r\n        debug(err)\r\n        this.emit('error', err)\r\n      })\r\n      clearTimeout(this.checkPollingId)\r\n      this.checkPollingId = setTimeout(() => this.checkPolling(), this._getPollingInterval())\r\n    }\r\n  }\r\n\r\n  handleSync (data) {\r\n    if (!data) {\r\n      this.restart()\r\n      return\r\n    }\r\n    if (data.AddMsgCount) {\r\n      debug('syncPolling messages count: ', data.AddMsgCount)\r\n      this.handleMsg(data.AddMsgList)\r\n    }\r\n    if (data.ModContactCount) {\r\n      debug('syncPolling ModContactList count: ', data.ModContactCount)\r\n      this.updateContacts(data.ModContactList)\r\n    }\r\n  }\r\n\r\n  handleMsg (data) {\r\n    data.forEach(msg => {\r\n      Promise.resolve().then(() => {\r\n        if (!this.contacts[msg.FromUserName] ||\r\n          (msg.FromUserName.startsWith('@@') && this.contacts[msg.FromUserName].MemberCount == 0)) {\r\n          return this.batchGetContact([{\r\n            UserName: msg.FromUserName\r\n          }]).then(contacts => {\r\n            this.updateContacts(contacts)\r\n          }).catch(err => {\r\n            debug(err)\r\n            this.emit('error', err)\r\n          })\r\n        }\r\n      }).then(() => {\r\n        msg = this.Message.extend(msg)\r\n        this.emit('message', msg)\r\n        if (msg.MsgType === this.CONF.MSGTYPE_STATUSNOTIFY) {\r\n          let userList = msg.StatusNotifyUserName.split(',').filter(UserName => !this.contacts[UserName])\r\n          .map(UserName => {\r\n            return {\r\n              UserName: UserName\r\n            }\r\n          })\r\n          Promise.all(_.chunk(userList, 50).map(list => {\r\n            return this.batchGetContact(list).then(res => {\r\n              debug('batchGetContact data length: ', res.length)\r\n              this.updateContacts(res)\r\n            })\r\n          })).catch(err => {\r\n            debug(err)\r\n            this.emit('error', err)\r\n          })\r\n        }\r\n        if (msg.ToUserName === 'filehelper' && msg.Content === '退出wechat4u' ||\r\n          /^(.\\udf1a\\u0020\\ud83c.){3}$/.test(msg.Content)) {\r\n          this.stop()\r\n        }\r\n      }).catch(err => {\r\n        this.emit('error', err)\r\n        debug(err)\r\n      })\r\n    })\r\n  }\r\n\r\n  updateContacts (contacts) {\r\n    if (!contacts || contacts.length == 0) {\r\n      return\r\n    }\r\n    contacts.forEach(contact => {\r\n      if (this.contacts[contact.UserName]) {\r\n        let oldContact = this.contacts[contact.UserName]\r\n        // 清除无效的字段\r\n        for (let i in contact) {\r\n          contact[i] || delete contact[i]\r\n        }\r\n        Object.assign(oldContact, contact)\r\n        this.Contact.extend(oldContact)\r\n      } else {\r\n        this.contacts[contact.UserName] = this.Contact.extend(contact)\r\n      }\r\n    })\r\n    this.emit('contacts-updated', contacts)\r\n  }\r\n\r\n  _getPollingMessage () { // Default polling message\r\n    return '心跳：' + new Date().toLocaleString()\r\n  }\r\n\r\n  _getPollingInterval () { // Default polling interval\r\n    return 5 * 60 * 1000\r\n  }\r\n\r\n  _getPollingTarget () { // Default polling target user\r\n    return 'filehelper'\r\n  }\r\n\r\n  setPollingMessageGetter (func) {\r\n    if (typeof (func) !== 'function') return\r\n    if (typeof (func()) !== 'string') return\r\n    this._getPollingMessage = func\r\n  }\r\n\r\n  setPollingIntervalGetter (func) {\r\n    if (typeof (func) !== 'function') return\r\n    if (typeof (func()) !== 'number') return\r\n    this._getPollingInterval = func\r\n  }\r\n\r\n  setPollingTargetGetter (func) {\r\n    if (typeof (func) !== 'function') return\r\n    if (typeof (func()) !== 'string') return\r\n    this._getPollingTarget = func\r\n  }\r\n\r\n}\r\n\r\nWechat.STATE = getCONF().STATE\r\n\r\nexports = module.exports = Wechat\r\n"]}